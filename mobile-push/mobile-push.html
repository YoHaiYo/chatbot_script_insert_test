<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase 푸시 알림 테스트</title>

    <!-- jQuery 로드 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebase SDK (compat 버전) -->
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-messaging-compat.js"></script>
  </head>
  <body>
    <h2>Firebase 웹 푸시 알림</h2>
    <label
      >이미지 URL:
      <input
        type="text"
        id="icon"
        value="https://xerost.ai/static/front/img/logo.png" /></label
    ><br /><br />
    <label
      >알림 제목: <input type="text" id="title" value="테스트 알림" /></label
    ><br /><br />
    <label
      >알림 내용:
      <input
        type="text"
        id="message"
        value="이것은 Firebase 푸시 알림입니다." /></label
    ><br /><br />
    <label
      >이동할 URL:
      <input type="text" id="url" value="https://www.google.com" /></label
    ><br /><br />
    <button id="subscribe">알림 허용</button>
    <button id="send">푸시 알림 생성</button>
    <p>FCM 토큰: <span id="token">N/A</span></p>

    <script>
      // ✅ Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyDO0TY9fWIQiUTIe6Oqy2GXKyXqhDiwSas",
        projectId: "sshtest-b0a70",
        storageBucket: "sshtest-b0a70.appspot.com",
        messagingSenderId: "229082605379",
        appId: "1:229082605379:web:f3825bee241b460dc931f6",
      };

      // ✅ Firebase 초기화
      firebase.initializeApp(firebaseConfig);
      const messaging = firebase.messaging();

      // ✅ 알림 권한 요청 및 FCM 토큰 가져오기
      $("#subscribe").click(function () {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            messaging
              .getToken({
                vapidKey:
                  "BBtkOwm79Db4Q1K62fZVATXDJoBRogOc4BVWKIO1s7EhWpgeD2gWeUi8aoIUyauhTTQJLwblEdGvYC1AS2ljj0Q",
              })
              .then((token) => {
                if (token) {
                  $("#token").text(token);
                  console.log("FCM Token:", token);
                } else {
                  console.error("토큰 가져오기 실패");
                }
              })
              .catch((error) => console.error("토큰 요청 오류:", error));
          } else {
            alert("알림 권한이 차단되었습니다.");
          }
        });
      });

      // ✅ 푸시 알림 보내기 (서버 요청)
      $("#send").click(function () {
        const token = $("#token").text();
        if (token === "N/A") {
          alert("먼저 알림 허용을 해주세요!");
          return;
        }

        const payload = {
          to: token,
          notification: {
            title: $("#title").val(),
            body: $("#message").val(),
            icon: $("#icon").val(),
            click_action: $("#url").val(),
          },
        };

        $.ajax({
          url: "https://fcm.googleapis.com/fcm/send",
          method: "POST",
          contentType: "application/json",
          headers: {
            Authorization: "key=AIzaSyDO0TY9fWIQiUTIe6Oqy2GXKyXqhDiwSas", // ✅ Firebase 서버 키 입력
            "Content-Type": "application/json",
          },
          data: JSON.stringify(payload),
          success: function (response) {
            console.log("푸시 알림 성공:", response);
            alert("푸시 알림이 전송되었습니다!");
          },
          error: function (xhr, status, error) {
            console.error("푸시 알림 실패:", error);
            alert("푸시 알림 전송 실패!");
          },
        });
      });

      // ✅ 푸시 메시지 수신 처리
      messaging.onMessage((payload) => {
        console.log("푸시 메시지 수신:", payload);
        alert(`알림 수신: ${payload.notification.title}`);
      });
    </script>
  </body>
</html>
