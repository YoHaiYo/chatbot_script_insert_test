<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase ì›¹ í‘¸ì‹œ ì•Œë¦¼</title>
    <style>
      #log {
        width: 100%;
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background: #f9f9f9;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h2>Firebase ì›¹ í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ 2</h2>
    <label
      >ì´ë¯¸ì§€ URL:
      <input
        type="text"
        id="icon"
        value="https://xerost.ai/static/front/img/logo.png" /></label
    ><br /><br />
    <label
      >ì•Œë¦¼ ì œëª©: <input type="text" id="title" value="í…ŒìŠ¤íŠ¸ ì•Œë¦¼" /></label
    ><br /><br />
    <label
      >ì•Œë¦¼ ë‚´ìš©:
      <input
        type="text"
        id="message"
        value="ì´ê²ƒì€ Firebase í‘¸ì‹œ ì•Œë¦¼ì…ë‹ˆë‹¤." /></label
    ><br /><br />
    <label
      >ì´ë™í•  URL:
      <input type="text" id="url" value="https://xerovatar.xerost.ai/" /></label
    ><br /><br />
    <button id="subscribe">ì•Œë¦¼ í—ˆìš©</button>
    <button id="send">í‘¸ì‹œ ì•Œë¦¼ ìƒì„±</button>
    <p>FCM í† í°: <span id="token">N/A</span></p>

    <!-- âœ… ë¡œê·¸ í™”ë©´ í‘œì‹œ -->
    <h3>ğŸ“œ ë¡œê·¸:</h3>
    <div id="log"></div>

    <!-- Firebase SDK ìµœì‹  ë²„ì „ ë¡œë“œ -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-messaging.js";

      // âœ… ë¡œê·¸ë¥¼ í™”ë©´ì— ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
      function logMessage(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML += `<p>${message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // âœ… Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: "AIzaSyDO0TY9fWIQiUTIe6Oqy2GXKyXqhDiwSas",
        authDomain: "sshtest-b0a70.firebaseapp.com",
        databaseURL:
          "https://sshtest-b0a70-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sshtest-b0a70",
        storageBucket: "sshtest-b0a70.appspot.com",
        messagingSenderId: "229082605379",
        appId: "1:229082605379:web:f3825bee241b460dc931f6",
        measurementId: "G-NM8EZR1CZ7",
      };

      // âœ… Firebase ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);
      logMessage("âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ");

      // âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
      navigator.serviceWorker
        .register("/mobile-push/firebase-messaging-sw.js")
        .then((registration) => {
          logMessage("âœ… Service Worker ë“±ë¡ ì„±ê³µ");
        })
        .catch((error) => {
          logMessage(`âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨: ${error.message}`);
        });

      // âœ… ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë° FCM í† í° ê°€ì ¸ì˜¤ê¸°
      document
        .getElementById("subscribe")
        .addEventListener("click", async () => {
          try {
            const permission = await Notification.requestPermission();
            logMessage(`ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ: ${permission}`);

            if (permission === "granted") {
              const token = await getToken(messaging, {
                vapidKey:
                  "BBtkOwm79Db4Q1K62fZVATXDJoBRogOc4BVWKIO1s7EhWpgeD2gWeUi8aoIUyauhTTQJLwblEdGvYC1AS2ljj0Q",
                serviceWorkerRegistration: await navigator.serviceWorker.ready,
              });
              if (token) {
                document.getElementById("token").textContent = token;
                logMessage(`âœ… FCM Token: ${token}`);
              } else {
                logMessage("âŒ í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨");
              }
            } else {
              logMessage("âŒ ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë¨");
            }
          } catch (error) {
            logMessage(`âŒ í† í° ìš”ì²­ ì˜¤ë¥˜: ${error.message}`);
          }
        });

      // âœ… í‘¸ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
      onMessage(messaging, (payload) => {
        logMessage(`ğŸ“© í‘¸ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹ : ${JSON.stringify(payload)}`);
        alert(`ì•Œë¦¼ ìˆ˜ì‹ : ${payload.notification.title}`);
      });

      // âœ… í‘¸ì‹œ ì•Œë¦¼ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— ìš”ì²­
      document.getElementById("send").addEventListener("click", () => {
        const token = document.getElementById("token").textContent;
        if (token === "N/A") {
          logMessage("âŒ ë¨¼ì € ì•Œë¦¼ í—ˆìš©ì„ í•´ì£¼ì„¸ìš”!");
          return;
        }

        const payload = {
          to: token,
          notification: {
            title: document.getElementById("title").value,
            body: document.getElementById("message").value,
            icon: document.getElementById("icon").value,
            click_action: document.getElementById("url").value,
          },
        };

        fetch("https://fcm.googleapis.com/fcm/send", {
          method: "POST",
          headers: {
            Authorization: "Bearer YOUR_ACCESS_TOKEN",
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) =>
            logMessage(`âœ… í‘¸ì‹œ ì•Œë¦¼ ì„±ê³µ: ${JSON.stringify(data)}`)
          )
          .catch((error) => logMessage(`âŒ í‘¸ì‹œ ì•Œë¦¼ ì‹¤íŒ¨: ${error.message}`));
      });
    </script>
  </body>
</html>
